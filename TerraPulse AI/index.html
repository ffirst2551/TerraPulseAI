<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraPulse |Environmental AI Dashboard v2.0</title>
    <!-- Nuclear Cache Breaking & Diagnostics -->
    <script>
        (function() {
            console.log("[Nuclear] System Initializing...");
            // Force unregister all service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log("[Nuclear] Unregistered SW:", registration);
                    }
                });
            }
            // Clear all caches
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) caches.delete(name);
                });
            }
        })();
    </script>
    <!-- Dependencies with Cache Busters & CORS -->
    <script src="https://cdn.tailwindcss.com?v=2.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.0/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.263.1/dist/umd/lucide-react.min.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TerraPulse">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        :root {
            --slate-900: #0F172A;
            --emerald-500: #10B981;
            --emerald-600: #059669;
            --emerald-400: #34D399;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(16, 185, 129, 0.2);
            --emerald-glow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        body {
            background-color: var(--slate-900);
            color: #F8FAFC;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, .heading-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        .glass-morphism {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(6px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--emerald-glow);
            transform: translateZ(0); /* Hardware Acceleration */
        }

        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: width;
        }

        .scanning-line {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--emerald-400), transparent);
            box-shadow: 0 0 5px var(--emerald-400);
            position: absolute;
            width: 100%;
            z-index: 10;
            animation: scan 2s linear infinite;
            will-change: top;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        @keyframes acoustic-wave {
            0%, 100% { transform: scaleY(0.35); opacity: 0.45; }
            50% { transform: scaleY(1); opacity: 1; }
        }
        .animate-acoustic-wave {
            transform-origin: bottom;
            animation: acoustic-wave 0.9s ease-in-out infinite;
        }

        @keyframes acoustic-ping {
            0% { transform: scale(0.85); opacity: 0.7; }
            70% { transform: scale(1.25); opacity: 0; }
            100% { transform: scale(1.25); opacity: 0; }
        }
        .animate-acoustic-ping { animation: acoustic-ping 1.4s ease-out infinite; }

        .glow-emerald {
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.5));
        }

        .micro-interaction {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .micro-interaction:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--emerald-500);
            border-radius: 10px;
        }

        .resnet-node {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #475569;
            position: relative;
        }

        .resnet-node.active {
            background: var(--emerald-400);
            box-shadow: 0 0 12px var(--emerald-500);
        }

        .resnet-line {
            height: 2px;
            background: #334155;
            flex-grow: 1;
        }

        .resnet-line.active {
            background: var(--emerald-500);
        }

        .stat-card-premium {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.5));
            border: 1px solid rgba(16, 185, 129, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.05), transparent);
            transition: 0.5s;
        }

        .stat-card-premium:hover::before {
            left: 100%;
        }

        .stat-card-premium:hover {
            border-color: rgba(16, 185, 129, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.2);
        }

        .stat-icon-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .stat-card-premium:hover .stat-icon-box {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.6);
            transform: scale(1.1) rotate(5deg);
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes scale-up {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-up { animation: scale-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        .logo-pulse {
            animation: logo-pulse 2s infinite ease-in-out;
            will-change: transform;
            transform: translateZ(0);
        }

        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

            @keyframes spin-slow {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .animate-spin-slow { animation: spin-slow 12s linear infinite; }
            
            @keyframes pulse-slow {
                0%, 100% { opacity: 0.4; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.05); }
            }
            .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }

            @keyframes showcase-float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-8px); }
            }
            .animate-showcase-float { animation: showcase-float 6s ease-in-out infinite; }

            @keyframes showcase-scan {
                0% { transform: translateX(-120%); opacity: 0; }
                30% { opacity: 0.9; }
                100% { transform: translateX(120%); opacity: 0; }
            }
            .animate-showcase-scan { animation: showcase-scan 3.2s linear infinite; }

            @keyframes showcase-pop {
                from { opacity: 0; transform: translateY(14px) scale(0.98); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }
            .animate-showcase-pop { animation: showcase-pop 0.55s cubic-bezier(0.16, 1, 0.3, 1) both; }

            @keyframes showcase-orbit {
                from { transform: rotate(0deg) translateX(18px) rotate(0deg); }
                to { transform: rotate(360deg) translateX(18px) rotate(-360deg); }
            }
            .animate-showcase-orbit { animation: showcase-orbit 6s linear infinite; }
            
            .text-gradient-emerald {
                background: linear-gradient(135deg, #F8FAFC 30%, #10B981 100%);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }
    </style>
</head>
<body>
    <div id="loading" style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #020617; color: #10B981; font-family: 'Space Grotesk', sans-serif; gap: 30px; position: fixed; width: 100%; z-index: 9999; transition: opacity 0.5s; will-change: opacity;">
        <div class="logo-pulse" style="width: 80px; height: 80px; position: relative; display: flex; align-items: center; justify-content: center;">
            <svg viewBox="0 0 100 100" style="width: 100%; height: 100%; contain: strict;">
                <circle cx="50" cy="50" r="42" fill="rgba(16,185,129,0.08)" stroke="#10B981" stroke-width="2.4" />
                <circle cx="50" cy="50" r="30" fill="none" stroke="rgba(16,185,129,0.35)" stroke-width="1.5" stroke-dasharray="5 6" />
                <path d="M22 54 H34 L41 43 L50 62 L58 48 L66 54 H78" fill="none" stroke="#34D399" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px rgba(52,211,153,0.45));" />
                <path d="M50 30 C61 35 62 47 50 55 C38 47 39 35 50 30 Z" fill="#10B981" />
                <path d="M50 33 L50 52" fill="none" stroke="#052e1d" stroke-width="1.6" stroke-linecap="round" />
            </svg>
        </div>
        <div style="text-align: center;">
            <p class="text-gradient-emerald" style="letter-spacing: 0.3em; font-weight: 900; font-size: 1.5rem; margin: 0;">TERRAPULSE</p>
            <p style="font-size: 10px; color: #475569; margin-top: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">AI Forest Growth Intelligence for Blue Carbon</p>
        </div>
        <div id="loading-status" style="font-size: 11px; color: #10B981; opacity: 0.6; font-family: monospace; text-transform: uppercase; letter-spacing: 0.1em;">Synchronizing Core Modules...</div>
    </div>
    <div id="root"></div>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        #visual-console div { margin-bottom: 2px; line-height: 1.2; border-left: 2px solid transparent; padding-left: 5px; }
    </style>


    <script type="text/babel">
        // --- STARTUP DIAGNOSTICS ---
        console.log("%c[System] Babel Transpilation Started", "color: #10B981; font-weight: bold; font-size: 14px;");
        window.babelStarted = true;
        
        const API_KEY = "AIzaSyC3qXCToS-MLhZuxhRdKg68mLyoyejcAeU";
        const { useState, useEffect, useMemo, useRef } = React;

        console.log("[System] Dependencies Check:", {
            React: typeof React !== 'undefined',
            ReactDOM: typeof ReactDOM !== 'undefined',
            Recharts: typeof window.Recharts !== 'undefined',
            Lucide: typeof window.lucideReact !== 'undefined'
        });

        // --- Safe Library Access ---
        const getLibComp = (lib, name) => {
            if (!lib) return null;
            // Try different naming conventions
            const Comp = lib[name] || lib[name.charAt(0).toUpperCase() + name.slice(1).toLowerCase()] || (lib.icons ? lib.icons[name] : null);
            return (typeof Comp === 'function' || (Comp && typeof Comp === 'object')) ? Comp : null;
        };

        const getIcon = (name) => (props) => {
            const Lib = window.lucideReact || window.Lucide || window.lucide || {};
            const Comp = getLibComp(Lib, name) || 'span';
            return React.createElement(Comp, {
                ...props,
                strokeWidth: props.strokeWidth || 2,
                className: `lucide-icon ${props.className || ''}`
            });
        };

        // Local SVG fallback for dashboard stat icons (guarantees visible icons)
        const DashboardStatIcon = ({ name, size = 22, className = "" }) => {
            const svgProps = {
                width: size,
                height: size,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: 2.2,
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className
            };

            if (name === "Wind") {
                return (
                    <svg {...svgProps}>
                        <path d="M3 8h10c1.8 0 3-1.2 3-2.8S14.8 2.5 13 2.5c-1.4 0-2.5.8-2.9 2" />
                        <path d="M3 12h13c2.2 0 3.8 1.4 3.8 3.2S18.2 18.5 16 18.5c-1.6 0-2.9-.8-3.4-2" />
                        <path d="M3 16h8" />
                    </svg>
                );
            }
            if (name === "Leaf") {
                return (
                    <svg {...svgProps}>
                        <path d="M19 3c-7.2.4-12.7 5.7-13 12.8-.2 4 2.2 5.9 5.3 5.9C18.6 21.7 21 14.6 21 7.8V3h-2z" />
                        <path d="M8 14c2.2-2.7 5.1-4.8 8.6-6.2" />
                    </svg>
                );
            }
            if (name === "Activity") {
                return (
                    <svg {...svgProps}>
                        <polyline points="3 12 7 12 10 6 14 18 17 12 21 12" />
                    </svg>
                );
            }
            if (name === "TrendingUp") {
                return (
                    <svg {...svgProps}>
                        <polyline points="4 15 10 9 14 13 21 6" />
                        <polyline points="15 6 21 6 21 12" />
                    </svg>
                );
            }

            return getIcon(name)({ size, className });
        };

        // --- Custom Library-Free Visualizations ---
        const Sparkline = ({ data, color = "#10B981" }) => {
            if (!data || data.length < 2) return null;
            const width = 100;
            const height = 30;
            const padding = 2;
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * (height - padding * 2) - padding;
                return `${x},${y}`;
            }).join(' ');

            return (
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                    <polyline
                        fill="none"
                        stroke={color}
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        points={points}
                        style={{ filter: `drop-shadow(0 0 3px ${color}66)` }}
                    />
                </svg>
            );
        };

        const ProgressBar = ({ value, color = "var(--emerald-500)" }) => (
            <div className="w-full bg-slate-800/50 h-1.5 rounded-full overflow-hidden">
                <div 
                    className="h-full transition-all duration-1000 ease-out flex items-center justify-end pr-1"
                    style={{ width: `${value}%`, background: color, boxShadow: `0 0 10px ${color}44` }}
                >
                    <div className="w-1 h-1 bg-white/50 rounded-full animate-pulse"></div>
                </div>
            </div>
        );

        const MiniArea = ({ data, color = "#10B981" }) => {
            if (!data || data.length < 2) return null;
            const width = 200;
            const height = 60;
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * (height - 10) - 5;
                return `${x},${y}`;
            }).join(' ');

            const pathData = `M 0,${height} L ${points} L ${width},${height} Z`;

            return (
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full preserve-3d">
                    <defs>
                        <linearGradient id={`grad-${color.replace('#','')}`} x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style={{ stopColor: color, stopOpacity: 0.3 }} />
                            <stop offset="100%" style={{ stopColor: color, stopOpacity: 0 }} />
                        </linearGradient>
                    </defs>
                    <path d={pathData} fill={`url(#grad-${color.replace('#','')})`} />
                    <polyline
                        fill="none"
                        stroke={color}
                        strokeWidth="2.5"
                        strokeLinecap="round"
                        points={points}
                        style={{ filter: `drop-shadow(0 0 5px ${color}88)` }}
                    />
                </svg>
            );
        };

        // --- Exponential Backoff Fetch ---
        const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (retries > 0 && (response.status === 429 || response.status >= 500)) {
                        await new Promise(resolve => setTimeout(resolve, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw error;
            }
        };

        // Notification Component
        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            return (
                <div className={`fixed top-4 right-4 z-[100] p-4 rounded-lg shadow-lg border animate-slide-in ${
                    type === 'error' ? 'bg-red-900/80 border-red-500 text-red-100' : 'bg-emerald-900/80 border-emerald-500 text-emerald-100'
                }`}>
                    <div className="flex items-center gap-3">
                        {getIcon('AlertCircle')({ size: 18 })}
                        <p className="text-sm font-medium">{message}</p>
                        <button onClick={onClose} className="ml-4 hover:opacity-70">
                            {getIcon('X')({ size: 16 })}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Layout Components ---

        const Sidebar = ({ isCollapsed, setIsCollapsed, activeTab, setActiveTab }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'LayoutDashboard', label: 'Intelligence' },
                { id: 'showcase', icon: 'Star', label: 'Showcase' },
                { id: 'scanner', icon: 'Satellite', label: 'Scanner' },
                { id: 'ecosystem', icon: 'Zap', label: 'Ecosystem' },
                { id: 'history', icon: 'History', label: 'History' },
                { id: 'market', icon: 'TrendingUp', label: 'Market' },
                { id: 'plans', icon: 'Crown', label: 'Membership' },
                { id: 'chatbot', icon: 'Bot', label: 'AI Advisor' }
            ];

            return (
                <div className={`sidebar-transition h-screen glass-morphism sticky top-0 left-0 z-50 flex flex-col p-4 ${isCollapsed ? 'w-20' : 'w-64'}`}>
                    <div className="flex items-center justify-between mb-8 overflow-visible">
                        {!isCollapsed && (
                            <div className="flex items-center gap-3 animate-fade-in group">
                                <div className="relative w-10 h-10 rounded-xl border border-emerald-500/25 bg-gradient-to-br from-emerald-500/25 to-teal-500/10 flex items-center justify-center overflow-hidden group-hover:border-emerald-400/40 transition-all logo-pulse shrink-0">
                                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(16,185,129,0.28),transparent_60%)]"></div>
                                    <svg viewBox="0 0 24 24" className="relative z-10 w-6 h-6 text-emerald-300" fill="none" stroke="currentColor" strokeWidth="1.9" strokeLinecap="round" strokeLinejoin="round" aria-label="TerraPulse mark">
                                        <circle cx="12" cy="12" r="7.6" stroke="rgba(52,211,153,0.75)" />
                                        <path d="M5.2 12h3l1.3-1.9 1.9 3 1.8-2.4h2.1" />
                                        <path d="M12 7.3c2.1 1 2.3 3.2 0 4.6-2.3-1.4-2.1-3.6 0-4.6z" fill="currentColor" stroke="none" />
                                    </svg>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-xl font-black tracking-tight text-gradient-emerald">TerraPulse</span>
                                    <span className="text-[8px] uppercase tracking-[0.22em] text-emerald-500/55 font-bold -mt-1">Blue Carbon Growth AI</span>
                                </div>
                            </div>
                        )}
                        <button 
                            onClick={() => setIsCollapsed(!isCollapsed)}
                            className="p-2 hover:bg-emerald-500/10 rounded-lg text-emerald-500 transition-colors mx-auto lg:mx-0"
                        >
                            {isCollapsed ? getIcon('Menu')({ size: 24 }) : getIcon('ChevronLeft')({ size: 24 })}
                        </button>
                    </div>

                    <nav className="flex-1 space-y-2">
                        {menuItems.map((item) => {
                            const IconComponent = getIcon(item.icon);
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-200 group ${
                                        activeTab === item.id 
                                        ? 'bg-emerald-500 text-slate-900 font-semibold shadow-lg shadow-emerald-500/20' 
                                        : 'text-slate-400 hover:bg-emerald-500/10 hover:text-emerald-400'
                                    }`}
                                >
                                    <IconComponent size={22} className={activeTab === item.id ? '' : 'group-hover:scale-110 transition-transform'} />
                                    {!isCollapsed && <span className="animate-fade-in">{item.label}</span>}
                                </button>
                            );
                        })}
                    </nav>

                    <div className="mt-auto space-y-2">
                        {/* User Profile Section */}
                        <div className={`flex items-center gap-3 p-3 rounded-xl bg-slate-800/50 border border-emerald-500/10 ${isCollapsed ? 'justify-center' : ''}`}>
                            <div className="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center border border-emerald-500/30">
                                {getIcon('User')({ size: 16, className: "text-emerald-500" })}
                            </div>
                            {!isCollapsed && (
                                <div className="flex-1 overflow-hidden">
                                    <p className="text-[11px] font-bold text-slate-200 truncate leading-tight">Professional User</p>
                                    <p className="text-[9px] text-emerald-500/60 truncate uppercase tracking-tighter">Enterprise Plan Active</p>
                                </div>
                            )}
                        </div>

                        <div className={`flex items-center gap-3 p-3 text-xs text-slate-500 border-t border-emerald-500/10 ${isCollapsed ? 'justify-center' : ''}`}>
                            {getIcon('ShieldCheck')({ size: 16, className: "text-emerald-600" })}
                            {!isCollapsed && <span className="uppercase tracking-widest text-[9px] font-bold">Encrypted Session</span>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Pages ---

        // --- Static Data ---
        const DASHBOARD_STATS = [
            { label: 'Carbon Sequestered', value: '1.2M', unit: 'Tons', trend: '+12%', icon: 'Wind' },
            { label: 'Biomass Density', value: '45.8', unit: 'kg/mÂ²', trend: '+5%', icon: 'Leaf' },
            { label: 'Ecosystem Health', value: '94', unit: '%', trend: '+2%', icon: 'Activity' },
            { label: 'Market Valuation', value: '$840M', unit: 'USD', trend: '+24%', icon: 'TrendingUp' }
        ];

        const GROWTH_DATA = [
            { name: '2020', carbon: 450, biomass: 240 },
            { name: '2021', carbon: 600, biomass: 320 },
            { name: '2022', carbon: 780, biomass: 450 },
            { name: '2023', carbon: 1050, biomass: 600 },
            { name: '2024', carbon: 1200, biomass: 780 },
        ];

        // --- Pages ---

        const Dashboard = () => {
            const [activeSector, setActiveSector] = useState(0);
            const [chartMetric, setChartMetric] = useState('biomass');
            const [selectedYearIndex, setSelectedYearIndex] = useState(GROWTH_DATA.length - 1);
            const [isChartPlaying, setIsChartPlaying] = useState(false);

            const sectors = [
                { id: 0, name: 'Ranong Mangrove Belt', health: 92, biomass: 78, species: 64, offset: '2.4k t', growth: '+12.4%', x: 40, y: 35 },
                { id: 1, name: 'Phang Nga Bay Zone', health: 88, biomass: 72, species: 58, offset: '1.8k t', growth: '+8.2%', x: 43, y: 48 },
                { id: 2, name: 'Surat Thani Coast', health: 96, biomass: 84, species: 72, offset: '3.2k t', growth: '+15.1%', x: 51, y: 60 },
                { id: 3, name: 'Trat Estuary Reserve', health: 99, biomass: 91, species: 88, offset: '4.5k t', growth: '+22.4%', x: 65, y: 38 }
            ];

            const current = sectors[activeSector];
            const selectedGrowthYear = GROWTH_DATA[selectedYearIndex];
            const selectedGrowthValue = selectedGrowthYear[chartMetric];
            const chartMaxValue = useMemo(
                () => Math.max(...GROWTH_DATA.map((d) => d[chartMetric])),
                [chartMetric]
            );

            useEffect(() => {
                if (!isChartPlaying) return undefined;
                const timer = setInterval(() => {
                    setSelectedYearIndex((prev) => (prev + 1) % GROWTH_DATA.length);
                }, 900);
                return () => clearInterval(timer);
            }, [isChartPlaying]);

            return (
                <div className="space-y-10 pb-20 animate-fade-in relative z-10">
                    <header className="space-y-2">
                        <h2 className="text-4xl font-extrabold text-white">Environmental <span className="text-emerald-500">Intelligence Insights</span></h2>
                        <p className="text-slate-400 text-lg">Monitoring Blue Carbon ecosystem health and sequestration metrics in real-time.</p>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {DASHBOARD_STATS.map((stat, i) => {
                            return (
                                <div key={i} className="stat-card-premium p-6 rounded-[2rem] group">
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="stat-icon-box w-12 h-12 rounded-2xl text-emerald-400 group-hover:text-emerald-300">
                                            <DashboardStatIcon
                                                name={stat.icon}
                                                size={22}
                                                className="drop-shadow-[0_0_8px_rgba(16,185,129,0.4)]"
                                            />
                                        </div>
                                        <div className="flex flex-col items-end">
                                            <span className="text-emerald-400 text-[10px] font-black px-2 py-0.5 bg-emerald-500/10 rounded-full border border-emerald-500/20 tracking-tighter">
                                                {stat.trend}
                                            </span>
                                            <span className="text-[8px] text-slate-500 font-bold uppercase tracking-widest mt-1">Growth</span>
                                        </div>
                                    </div>
                                    <h4 className="flex flex-col mb-1">
                                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mb-1">{stat.label}</span>
                                        <div className="flex items-baseline gap-2">
                                            <span className="text-3xl font-black text-white tracking-tight">{stat.value}</span>
                                            <span className="text-emerald-500/40 text-xs font-bold">{stat.unit}</span>
                                        </div>
                                    </h4>
                                    <div className="w-full h-1 bg-slate-800/50 rounded-full overflow-hidden mt-4">
                                        <div className="bg-emerald-500/30 h-full rounded-full w-2/3 group-hover:bg-emerald-500/60 transition-all duration-700"></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Digital Twin Section */}
                        <div className="lg:col-span-2 glass-morphism p-10 rounded-[3rem] bg-slate-900/40 border border-emerald-500/20 relative overflow-hidden group">
                            <div className="absolute inset-0 bg-[radial-gradient(circle_at_70%_30%,rgba(16,185,129,0.05),transparent)]"></div>
                            
                            <div className="relative z-10 flex flex-col h-full">
                                <div className="flex justify-between items-start mb-10">
                                    <div>
                                        <h3 className="text-3xl font-black italic tracking-tighter uppercase mb-1">Ecosystem <span className="text-emerald-500">2D Eco Map</span></h3>
                                        <div className="flex items-center gap-2 text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                                            <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                            2D Monitoring Node: 0xF72A... Active: <span className="text-emerald-400 font-black">{current.name}</span>
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end">
                                        <div className="px-4 py-2 bg-slate-800/80 rounded-2xl border border-slate-700 flex items-center gap-2">
                                            {getIcon('ShieldCheck')({ size: 16, className: "text-emerald-500" })}
                                            <span className="text-[10px] font-black text-white uppercase italic tracking-widest">Polygon Verified</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-5 flex justify-center">
                                    <div className="w-full max-w-sm p-5 bg-slate-900/90 border border-emerald-500/20 rounded-3xl space-y-4 shadow-2xl">
                                        <div className="text-[10px] text-emerald-500 font-black uppercase tracking-widest mb-2 flex items-center gap-2">
                                            {getIcon('Settings')({ size: 12, className: "animate-spin-slow" })}
                                            Sector {activeSector + 1} Metrics
                                        </div>
                                        <div className="space-y-3">
                                            {[
                                                { l: 'Health', v: current.health, c: '#10B981' },
                                                { l: 'Biomass', v: current.biomass, c: '#3B82F6' },
                                                { l: 'Species', v: current.species, c: '#10B981' }
                                            ].map((m, i) => (
                                                <div key={i} className="space-y-1">
                                                    <div className="flex justify-between text-[8px] font-bold text-slate-500">
                                                        <span>{m.l}</span>
                                                        <span>{m.v}%</span>
                                                    </div>
                                                    <div className="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                                                        <div className="h-full transition-all duration-1000 ease-out" style={{ width: `${m.v}%`, backgroundColor: m.c }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex-1 min-h-[400px] bg-slate-950/40 rounded-[2.5rem] border-2 border-slate-900 overflow-hidden relative">
                                    <div className="absolute inset-0 opacity-20 bg-[linear-gradient(rgba(16,185,129,0.12)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.12)_1px,transparent_1px)] bg-[size:28px_28px]"></div>
                                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(16,185,129,0.18),transparent_55%),radial-gradient(circle_at_75%_60%,rgba(59,130,246,0.12),transparent_60%)]"></div>

                                    <div className="absolute inset-0 p-6 sm:p-8">
                                        <div className="relative w-full h-full rounded-[2rem] border border-emerald-500/20 bg-[#041322] overflow-hidden">
                                            <div className="absolute -left-10 top-8 w-48 h-48 bg-emerald-500/15 blur-3xl rounded-full"></div>
                                            <div className="absolute right-4 bottom-2 w-56 h-56 bg-blue-500/10 blur-3xl rounded-full"></div>
                                            <svg className="absolute inset-0 w-full h-full opacity-95" viewBox="0 0 1000 620" preserveAspectRatio="xMidYMid meet" aria-label="Thailand satellite map">
                                                <image
                                                    href="./581299870_1275550294611565_5142648980775277388_n.jpg"
                                                    x="0"
                                                    y="0"
                                                    width="1000"
                                                    height="620"
                                                    preserveAspectRatio="xMidYMid slice"
                                                />
                                                <rect x="0" y="0" width="1000" height="620" fill="rgba(6,17,32,0.18)" />

                                            </svg>
                                            <div className="absolute top-4 left-4 px-4 py-2 bg-slate-900/85 border border-emerald-500/20 rounded-xl text-[9px] font-black text-emerald-400 uppercase tracking-widest">
                                                Active Area: {current.name}
                                            </div>
                                            <div className="absolute top-4 right-4 px-3 py-1 bg-slate-900/85 border border-emerald-500/20 rounded-lg text-[8px] font-black text-slate-300 uppercase tracking-widest">
                                                Thailand Photo Layer
                                            </div>

                                            {sectors.map((s, idx) => (
                                                <button
                                                    key={s.id}
                                                    onClick={() => setActiveSector(idx)}
                                                    aria-label={`Select ${s.name}`}
                                                    className={`absolute w-12 h-12 rounded-full border-2 transition-all duration-300 flex items-center justify-center -translate-x-1/2 -translate-y-1/2
                                                        ${activeSector === idx ? 'bg-emerald-500 border-white shadow-[0_0_20px_#10B981] scale-125 z-20' : 'bg-slate-900/80 border-emerald-500/50 hover:bg-emerald-500/20 z-10'}
                                                    `}
                                                    style={{ top: `${s.y}%`, left: `${s.x}%` }}
                                                >
                                                    <div className={`w-2 h-2 rounded-full ${activeSector === idx ? 'bg-white animate-ping' : 'bg-emerald-500'}`}></div>
                                                </button>
                                            ))}

                                            <div className="absolute bottom-4 right-4 px-3 py-1 bg-slate-900/85 border border-emerald-500/20 rounded-lg text-[8px] font-black text-slate-300 uppercase tracking-widest">
                                                Thailand View
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="absolute bottom-10 left-10 flex gap-4 z-30">
                                        <div className="p-4 bg-slate-900/80 backdrop-blur rounded-2xl border border-slate-800">
                                            <div className="text-[8px] text-slate-500 uppercase font-black mb-1 tracking-widest">Growth Vector</div>
                                            <div className="text-lg font-black text-emerald-500 italic leading-none">{current.growth}</div>
                                        </div>
                                        <div className="p-4 bg-slate-900/80 backdrop-blur rounded-2xl border border-slate-800">
                                            <div className="text-[8px] text-slate-500 uppercase font-black mb-1 tracking-widest">Co2 Offset</div>
                                            <div className="text-lg font-black text-blue-400 italic leading-none">{current.offset}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Biomass Distribution Card */}
                        <div className="glass-morphism p-8 rounded-[2rem] bg-slate-900/60 border border-slate-800 flex flex-col">
                            <div className="flex items-center justify-between gap-3 mb-6">
                                <h3 className="text-xl font-bold">Biomass Distribution</h3>
                                <button
                                    type="button"
                                    onClick={() => setIsChartPlaying((prev) => !prev)}
                                    className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest border transition-colors ${
                                        isChartPlaying
                                            ? 'bg-emerald-500 text-slate-900 border-emerald-400'
                                            : 'bg-slate-900/80 text-slate-300 border-slate-700 hover:border-emerald-500/40'
                                    }`}
                                >
                                    {isChartPlaying ? 'Pause' : 'Play'}
                                </button>
                            </div>

                            <div className="flex items-center justify-between gap-2 mb-5">
                                <div className="inline-flex bg-slate-800/70 border border-slate-700 rounded-xl p-1">
                                    <button
                                        type="button"
                                        onClick={() => setChartMetric('biomass')}
                                        className={`px-3 py-1 text-[10px] font-bold rounded-lg transition-colors ${
                                            chartMetric === 'biomass' ? 'bg-emerald-500 text-slate-900' : 'text-slate-400 hover:text-slate-200'
                                        }`}
                                    >
                                        Biomass
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setChartMetric('carbon')}
                                        className={`px-3 py-1 text-[10px] font-bold rounded-lg transition-colors ${
                                            chartMetric === 'carbon' ? 'bg-emerald-500 text-slate-900' : 'text-slate-400 hover:text-slate-200'
                                        }`}
                                    >
                                        Carbon
                                    </button>
                                </div>
                                <div className="text-right">
                                    <div className="text-[9px] uppercase tracking-widest text-slate-500 font-black">Selected Year</div>
                                    <div className="text-sm font-black text-emerald-400">{selectedGrowthYear.name}</div>
                                </div>
                            </div>

                            <div className="h-36 w-full mb-6 flex items-end gap-2 px-1">
                                {GROWTH_DATA.map((d, i) => {
                                    const value = d[chartMetric];
                                    const isActive = i === selectedYearIndex;
                                    return (
                                        <button
                                            key={d.name}
                                            type="button"
                                            onClick={() => {
                                                setSelectedYearIndex(i);
                                                setIsChartPlaying(false);
                                            }}
                                            className="flex-1 flex flex-col items-center gap-2 group"
                                            aria-label={`Select year ${d.name}`}
                                        >
                                            <div className={`w-full rounded-lg border transition-all ${
                                                isActive
                                                    ? 'bg-emerald-500/50 border-emerald-300 shadow-[0_0_20px_rgba(16,185,129,0.35)]'
                                                    : 'bg-emerald-500/20 border-emerald-500/20 group-hover:bg-emerald-500/35 group-hover:border-emerald-500/50'
                                            }`} style={{ height: `${(value / chartMaxValue) * 100}%` }}></div>
                                            <span className={`text-[10px] font-bold ${isActive ? 'text-emerald-400' : 'text-slate-500'}`}>{d.name.slice(-2)}</span>
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="mb-6 p-4 rounded-2xl bg-slate-900/60 border border-slate-800">
                                <div className="text-[9px] uppercase tracking-widest text-slate-500 font-black mb-1">
                                    {chartMetric === 'biomass' ? 'Biomass Snapshot' : 'Carbon Snapshot'}
                                </div>
                                <div className="flex items-end justify-between gap-3">
                                    <div className="text-2xl font-black text-emerald-400 leading-none">{selectedGrowthValue}</div>
                                    <div className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                                        {chartMetric === 'biomass' ? 'kg/m2 equivalent' : 'tCO2e equivalent'}
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-6 pt-6 border-t border-slate-800 mt-auto">
                                <h4 className="text-[10px] font-bold text-slate-600 uppercase tracking-[0.2em]">ResNet-50 Performance</h4>
                                <div className="space-y-4">
                                    <div className="flex justify-between items-end">
                                        <div className="text-xs">
                                            <p className="text-slate-500 mb-1">Epoch Progress</p>
                                            <p className="text-2xl font-black text-emerald-400">128/150</p>
                                        </div>
                                        <div className="h-10 w-24">
                                            <Sparkline data={[10, 25, 18, 42, 35, 50, 48, 65]} color="#14b8a6" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/10 text-center">
                                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">TRAIN ACC</p>
                                            <p className="text-lg font-black text-emerald-400">98.4%</p>
                                        </div>
                                        <div className="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/10 text-center">
                                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">VAL ACC</p>
                                            <p className="text-lg font-black text-emerald-400">97.2%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Scanner = ({ setNotify }) => {
            const [selectedImage, setSelectedImage] = useState(null); // Keep this line
            const [isScanning, setIsScanning] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [scannerMode, setScannerMode] = useState('satellite'); // 'satellite' or 'acoustic'
            const [scanStep, setScanStep] = useState(0); // 0 to 4 for ResNet steps
            const [scanProgress, setScanProgress] = useState(0); // 0 to 100
            const [acousticBands, setAcousticBands] = useState(() =>
                Array.from({ length: 20 }, () => Math.round(18 + Math.random() * 18))
            );
            const [acousticTelemetry, setAcousticTelemetry] = useState({
                db: 58,
                bio: 68,
                freq: "2.4",
                anomaly: 6
            });
            
            const pipelineSteps = [
                { label: 'Input Pre-processing', detail: 'Normalization & Resize' },
                { label: 'Conv1 + Max-Pool', detail: 'Initial Feature Extraction' },
                { label: 'Residual Blocks (1-4)', detail: 'Deep Pattern Synthesis' },
                { label: 'Global Average Pool', detail: 'Dimensionality Reduction' },
                { label: 'Softmax Classifier', detail: 'Stage Classification' }
            ];

            const sampleInsights = {
                './samples/mangrove_1.png': {
                    stage: "Stage IV",
                    confidence: 0.985,
                    metrics: { carbon_tco2: 1450, biomass_index: 0.92 },
                    description: "Pristine mangrove ecosystem with maximal carbon sequestration potential.",
                    explainer: "à¸à¸µà¹à¸à¸·à¸­ 'à¸à¸­à¸à¸à¸­à¸à¸à¸²à¸¢à¸à¸±à¹à¸' à¸à¸µà¹à¸ªà¸¡à¸à¸¹à¸£à¸à¹à¹à¸à¸à¸à¸µà¹à¸ªà¸¸à¸à¸à¸£à¸±à¸! à¸à¹à¸²à¸à¸¸à¸à¸à¸µà¹à¸à¹à¸§à¸¢à¸à¸±à¸à¹à¸à¹à¸à¸à¸²à¸£à¹à¸à¸­à¸à¹à¸à¹à¸¡à¸«à¸²à¸¨à¸²à¸¥ à¹à¸¥à¸°à¹à¸à¹à¸à¸à¸£à¸²à¸à¸²à¸£à¸à¸£à¸£à¸¡à¸à¸²à¸à¸´à¸à¸µà¹à¹à¸à¹à¸à¹à¸à¸£à¹à¸à¸à¸µà¹à¸ªà¸¸à¸à¹à¸à¸à¸²à¸£à¸à¹à¸­à¸à¸à¸±à¸à¸à¸¥à¸·à¹à¸à¸¥à¸¡à¸à¸²à¸¢à¸¸à¸à¸£à¸±à¸"
                },
                './samples/mangrove_2.png': {
                    stage: "Stage III",
                    confidence: 0.942,
                    metrics: { carbon_tco2: 980, biomass_index: 0.78 },
                    description: "Healthy estuarine restoration area with active growth.",
                    explainer: "à¸à¸³à¸¥à¸±à¸à¹à¸à¸´à¸à¹à¸à¹à¸à¹à¸à¸µà¹à¸¢à¸µà¹à¸¢à¸¡à¹à¸¥à¸¢à¸à¸£à¸±à¸! à¸à¹à¸²à¸à¸¸à¸à¸à¸µà¹à¹à¸ªà¸à¸à¹à¸«à¹à¹à¸«à¹à¸à¸§à¹à¸²à¸à¸²à¸£à¸à¸·à¹à¸à¸à¸¹à¸à¸³à¸¥à¸±à¸à¹à¸à¹à¸à¸¥ à¹à¸¥à¸°à¸à¸°à¸à¸¥à¸²à¸¢à¹à¸à¹à¸à¹à¸«à¸¥à¹à¸à¸à¸±à¸à¹à¸à¹à¸à¸à¸²à¸£à¹à¸à¸­à¸à¸à¸±à¹à¸à¸à¸µà¹à¸à¸­à¸à¸²à¸à¸à¸­à¸±à¸à¹à¸à¸¥à¹à¸à¸£à¸±à¸"
                },
                './samples/mangrove_3.png': {
                    stage: "Stage I",
                    confidence: 0.925,
                    metrics: { carbon_tco2: 120, biomass_index: 0.15 },
                    description: "Initial seedling stage in restoration zone.",
                    explainer: "à¸à¸¸à¸à¹à¸£à¸´à¹à¸¡à¸à¹à¸à¸à¸­à¸à¸à¸§à¸²à¸¡à¸«à¸§à¸±à¸à¸à¸£à¸±à¸! à¹à¸¡à¹à¸à¸­à¸à¸à¸µà¹à¸à¸°à¸¢à¸±à¸à¸¡à¸µà¸à¸²à¸£à¹à¸à¸­à¸à¹à¸¡à¹à¸¡à¸²à¸ à¹à¸à¹à¸à¸²à¸£à¸à¸¹à¹à¸¥à¸£à¸±à¸à¸©à¸²à¸à¸·à¹à¸à¸à¸µà¹à¸à¸°à¸à¹à¸§à¸¢à¹à¸«à¹à¸«à¸±à¸§à¹à¸à¸à¸­à¸à¸à¹à¸²à¸à¸²à¸¢à¹à¸¥à¸à¸à¸¥à¸±à¸à¸¡à¸²à¹à¸à¹à¸à¹à¸£à¸à¸­à¸µà¸à¸à¸£à¸±à¹à¸à¸à¸£à¸±à¸"
                }
            };

            const onImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => setSelectedImage(e.target.result);
                    reader.readAsDataURL(file);
                    setAnalysisResult(null);
                    setScanStep(0);
                    setScanProgress(0);
                }
            };

            useEffect(() => {
                if (scannerMode !== 'acoustic') return undefined;

                const timer = setInterval(() => {
                    const bandBase = isScanning ? 46 : 26;
                    const bandRange = isScanning ? 52 : 24;
                    setAcousticBands(
                        Array.from({ length: 20 }, () => Math.round(bandBase + Math.random() * bandRange))
                    );

                    const baseDb = isScanning ? 64 : 57;
                    const baseBio = isScanning ? 74 : 66;
                    setAcousticTelemetry({
                        db: Math.round(baseDb + Math.random() * (isScanning ? 24 : 12)),
                        bio: Math.round(baseBio + Math.random() * (isScanning ? 22 : 14)),
                        freq: (1.2 + Math.random() * (isScanning ? 5.8 : 3.2)).toFixed(1),
                        anomaly: Math.round(Math.random() * (isScanning ? 20 : 10))
                    });
                }, isScanning ? 170 : 520);

                return () => clearInterval(timer);
            }, [scannerMode, isScanning]);

            const animateScanProgress = (from, to, duration = 850) => new Promise((resolve) => {
                const start = performance.now();
                const tick = (now) => {
                    const t = Math.min((now - start) / duration, 1);
                    setScanProgress(Math.round(from + (to - from) * t));
                    if (t < 1) {
                        requestAnimationFrame(tick);
                    } else {
                        resolve();
                    }
                };
                requestAnimationFrame(tick);
            });

            const runAnalysis = async () => {
                if (!selectedImage) return;
                setIsScanning(true);
                setAnalysisResult(null);
                setScanStep(0);
                setScanProgress(0);
                
                // Simulate ResNet Pipeline
                for (let i = 0; i <= 4; i++) {
                    setScanStep(i);
                    await animateScanProgress(i * 20, (i + 1) * 20);
                    await new Promise(r => setTimeout(r, 120));
                }

                try {
                    let parsed = null;
                    const sampleResult = sampleInsights[selectedImage];
                    if (sampleResult) {
                        await new Promise(r => setTimeout(r, 350));
                        parsed = sampleResult;
                    } else {
                    const imageData = selectedImage.split(',')[1];
                    const isAcoustic = scannerMode === 'acoustic';
                    const prompt = isAcoustic 
                        ? `Act as an environmental Bio-Acoustics AI model (AST). 
                           Analyze the visual representation of this audio spectrum (mangrove forest sound) and identify biodiversity status.
                           Requirements: 
                           - "stage": Identify predominant species signal (e.g., "Crab Colony", "Rich Avian Diversity", "Silent / Low Biodiversity").
                           - "confidence": 0.85 - 0.98.
                           - "metrics": { "carbon_tco2": "N/A", "biomass_index": Biodiversity Index 0.1-1.0 }.
                           - "explainer": A conversational Thai explanation about why these sounds indicate a healthy (or unhealthy) ecosystem.
                           Respond only with JSON.`
                        : `Act as an environmental AI model named ResNet-50 specialized in Blue Carbon ecosystems.
                           Analyze this satellite imagery and provide a professional assessment in JSON format ONLY.
                           Requirements:
                           - "stage": Choose one of "Stage I", "Stage II", "Stage III", "Stage IV", or "Unstageable".
                           - "confidence": A confidence score between 0.92 and 0.99.
                           - "metrics": { "carbon_tco2": Estimated sequestration value, "biomass_index": Biomass index 0-1 }.
                           - "description": A technical summary (in English).
                           - "explainer": A conversational explanation in THAI (à¸ à¸²à¸©à¸²à¹à¸à¸¢) for non-experts, explaining what the data means for the environment, why it's important, and a "WOW" fact about this stage.
                           Respond ONLY with JSON.`;

                    const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: "image/jpeg", data: imageData } }
                                ]
                            }]
                        })
                    });

                    const textResponse = result.candidates[0].content.parts[0].text;
                    parsed = JSON.parse(textResponse.replace(/```json|```/g, ''));
                    }
                    setAnalysisResult(parsed);
                    
                    // Production Logic: Save to History
                    const historyItem = {
                        id: Date.now(),
                        date: new Date().toLocaleString('th-TH'),
                        image: selectedImage,
                        ...parsed
                    };
                    window.dispatchEvent(new CustomEvent('saveAnalysis', { detail: historyItem }));

                    setNotify({ message: 'Analysis complete. Ecosystem status identified.', type: 'success' });
                } catch (error) {
                    setNotify({ message: 'Analysis failed: ' + error.message, type: 'error' });
                } finally {
                    setIsScanning(false);
                }
            };

            return (
                <div className="space-y-8 animate-fade-in relative z-10">
                    <header className="flex justify-between items-end">
                        <div className="space-y-2">
                            <h2 className="text-3xl font-bold text-emerald-400">Satellite <span className="text-white">Analysis Engine</span></h2>
                            <p className="text-slate-400 text-sm">Deploying ResNet-50 architecture for precision Blue Carbon stage classification.</p>
                        </div>
                        <div className="glass-morphism px-4 py-2 rounded-xl border-emerald-500/20 flex items-center gap-3">
                            <div className="flex flex-col items-end">
                                <span className="text-[10px] text-slate-500 uppercase font-black tracking-widest">Active Limit</span>
                                <span className="text-xs font-bold text-emerald-400 italic">Unlimited Rai</span>
                            </div>
                            <div className="w-10 h-10 bg-emerald-500/10 rounded-lg flex items-center justify-center border border-emerald-500/20">
                                {getIcon('Infinity')({ size: 20, className: "text-emerald-500" })}
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Scanner UI */}
                        <div className="glass-morphism p-6 rounded-2xl relative overflow-hidden flex flex-col items-center">
                            <h3 className="text-lg font-bold mb-4 self-start">à¸à¹à¸­à¸¡à¸¹à¸¥à¸ à¸²à¸à¸ªà¸à¸à¸²à¸à¸à¸²à¸§à¹à¸à¸µà¸¢à¸¡</h3>
                            
                            <div className="flex bg-slate-800/50 p-1 rounded-xl mb-6 w-full max-w-xs self-start border border-slate-700">
                                <button 
                                    onClick={() => setScannerMode('satellite')}
                                    className={`flex-1 py-2 px-3 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2 ${scannerMode === 'satellite' ? 'bg-emerald-500 text-slate-900 shadow-lg shadow-emerald-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                                >
                                    {getIcon('Satellite')({ size: 14 })}
                                    Satellite
                                </button>
                                <button 
                                    onClick={() => setScannerMode('acoustic')}
                                    className={`flex-1 py-2 px-3 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2 ${scannerMode === 'acoustic' ? 'bg-emerald-500 text-slate-900 shadow-lg shadow-emerald-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                                >
                                    {getIcon('Wind')({ size: 14 })}
                                    Bio-Acoustics
                                </button>
                            </div>

                            <div className="w-full aspect-video bg-slate-800 rounded-xl relative overflow-hidden group border border-slate-700">
                                {selectedImage ? (
                                    <>
                                        <img src={selectedImage} alt="satellite" className="w-full h-full object-cover" />
                                        {scannerMode === 'acoustic' && (
                                            <>
                                                <div className="absolute top-3 right-3 px-2 py-1 rounded-lg bg-slate-900/80 border border-emerald-500/30 text-[8px] font-black uppercase tracking-widest text-emerald-400 flex items-center gap-1.5">
                                                    <span className="relative flex h-2 w-2">
                                                        <span className="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 animate-acoustic-ping"></span>
                                                        <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-400"></span>
                                                    </span>
                                                    Hydrophone Live
                                                </div>

                                                {isScanning && (
                                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                        <div className="w-36 h-36 rounded-full border border-emerald-400/30 animate-ping"></div>
                                                    </div>
                                                )}

                                                <div className="absolute inset-x-0 bottom-0 h-32 flex items-end justify-around px-6 pb-4 opacity-85 pointer-events-none">
                                                    {acousticBands.map((h, i) => (
                                                        <div
                                                            key={i}
                                                            className="w-1.5 bg-gradient-to-t from-emerald-500/90 via-teal-400/80 to-cyan-300/70 rounded-full animate-acoustic-wave"
                                                            style={{
                                                                height: `${h}%`,
                                                                animationDelay: `${i * 0.06}s`
                                                            }}
                                                        ></div>
                                                    ))}
                                                </div>
                                            </>
                                        )}
                                        {isScanning && <div className="scanning-line"></div>}
                                    </>
                                ) : (
                                    <div className="w-full h-full flex flex-col items-center justify-center text-slate-500 gap-2">
                                        {getIcon('ImagePlus')({ size: 48, className: "opacity-20 translate-y-2 group-hover:translate-y-0 transition-transform" })}
                                        <p className="text-sm">
                                            {scannerMode === 'satellite' ? 'à¸£à¸­à¸£à¸±à¸à¸à¹à¸­à¸¡à¸¹à¸¥à¸à¸²à¸§à¹à¸à¸µà¸¢à¸¡à¸à¸§à¸²à¸¡à¸¥à¸°à¹à¸­à¸µà¸¢à¸à¸ªà¸¹à¸...' : 'à¸£à¸­à¸£à¸±à¸à¸ªà¸±à¸à¸à¸²à¸à¹à¸ªà¸µà¸¢à¸à¸à¸²à¸à¹à¸à¸à¹à¸à¸­à¸£à¹à¸ à¸²à¸à¸ªà¸à¸²à¸¡...'}
                                        </p>
                                    </div>
                                )}
                            </div>

                            {scannerMode === 'acoustic' && (
                                <div className="w-full mt-4 p-4 rounded-xl bg-slate-900/70 border border-emerald-500/20 space-y-3">
                                    <div className="flex items-center justify-between">
                                        <div className="text-[10px] uppercase tracking-widest font-black text-emerald-400 flex items-center gap-2">
                                            {getIcon('Activity')({ size: 14 })}
                                            Acoustic Telemetry
                                        </div>
                                        <div className="text-[10px] text-slate-400 font-bold">{isScanning ? 'Analyzing' : 'Standby'}</div>
                                    </div>

                                    <div className="grid grid-cols-4 gap-2">
                                        <div className="p-2 rounded-lg bg-slate-800/70 border border-slate-700">
                                            <div className="text-[8px] text-slate-500 uppercase font-black">Amplitude</div>
                                            <div className="text-sm font-black text-emerald-300">{acousticTelemetry.db} dB</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-slate-800/70 border border-slate-700">
                                            <div className="text-[8px] text-slate-500 uppercase font-black">Bio Index</div>
                                            <div className="text-sm font-black text-emerald-300">{acousticTelemetry.bio}%</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-slate-800/70 border border-slate-700">
                                            <div className="text-[8px] text-slate-500 uppercase font-black">Peak Freq</div>
                                            <div className="text-sm font-black text-emerald-300">{acousticTelemetry.freq} kHz</div>
                                        </div>
                                        <div className="p-2 rounded-lg bg-slate-800/70 border border-slate-700">
                                            <div className="text-[8px] text-slate-500 uppercase font-black">Anomaly</div>
                                            <div className="text-sm font-black text-emerald-300">{acousticTelemetry.anomaly}%</div>
                                        </div>
                                    </div>

                                    <div className="h-8 flex items-end gap-1">
                                        {acousticBands.slice(0, 14).map((h, i) => (
                                            <div
                                                key={i}
                                                className="flex-1 rounded-sm bg-emerald-500/70 animate-acoustic-wave"
                                                style={{ height: `${Math.max(20, h)}%`, animationDelay: `${i * 0.05}s` }}
                                            ></div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="w-full mt-6 space-y-4">
                                <div className="space-y-2">
                                    <p className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">à¹à¸¥à¸·à¸­à¸à¸ à¸²à¸à¸à¸±à¸§à¸­à¸¢à¹à¸²à¸à¸ªà¸³à¸«à¸£à¸±à¸à¸à¸²à¸£à¸ªà¸²à¸à¸´à¸ (Demo)</p>
                                    <div className="flex gap-2">
                                        {[
                                            { name: 'à¸à¸·à¹à¸à¸à¹à¸²à¸à¸²à¸¢à¹à¸¥à¸ 01', url: './samples/mangrove_1.png' },
                                            { name: 'à¸à¸²à¸à¹à¸¡à¹à¸à¹à¸³ 02', url: './samples/mangrove_2.png' },
                                            { name: 'à¸à¹à¸²à¸à¸²à¸¢à¸à¸±à¹à¸ 03', url: './samples/mangrove_3.png' }
                                        ].map((sample, i) => (
                                            <button 
                                                key={i}
                                                onClick={() => {
                                                    setSelectedImage(sample.url);
                                                    setAnalysisResult(null);
                                                    setScanStep(0);
                                                    setScanProgress(0);
                                                }}
                                                className="flex-1 text-[10px] bg-slate-800 hover:bg-emerald-500/20 border border-emerald-500/10 hover:border-emerald-500/30 p-2 rounded-lg transition-all text-slate-400 hover:text-emerald-400 font-bold"
                                            >
                                                {sample.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <label className="flex-1 cursor-pointer bg-slate-800 hover:bg-slate-700 border border-emerald-500/30 p-3 rounded-xl transition-all flex items-center justify-center gap-2 font-semibold">
                                        {getIcon('Upload')({ size: 18 })}
                                        <span>à¹à¸¥à¸·à¸­à¸à¹à¸à¸¥à¹</span>
                                        <input type="file" className="hidden" accept="image/*" onChange={onImageUpload} />
                                    </label>
                                    <button 
                                        disabled={!selectedImage || isScanning}
                                        onClick={runAnalysis}
                                        className={`flex-1 p-3 rounded-xl transition-all flex items-center justify-center gap-2 font-bold shadow-lg shadow-emerald-500/10 ${
                                            !selectedImage || isScanning ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-emerald-500 text-slate-900 hover:scale-[1.02]'
                                        }`}
                                    >
                                        {isScanning ? getIcon('Loader')({ size: 18, className: "animate-spin" }) : getIcon('Zap')({ size: 18 })}
                                        <span>{isScanning ? 'à¸à¸³à¸¥à¸±à¸à¸à¸£à¸°à¸¡à¸§à¸¥à¸à¸¥...' : 'à¹à¸£à¸´à¹à¸¡à¸§à¸´à¹à¸à¸£à¸²à¸°à¸«à¹ ResNet-50'}</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Analysis Pipeline */}
                        <div className="space-y-6">
                            <div className="glass-morphism p-6 rounded-2xl">
                                <h3 className="text-lg font-bold mb-6 flex items-center gap-2">
                                    {getIcon('Binary')({ size: 20, className: "text-emerald-500" })}
                                    ResNet Architecture Operations
                                </h3>
                                
                                <div className="mb-6 space-y-3">
                                    <div className="flex items-center justify-between text-[10px] font-bold uppercase tracking-widest">
                                        <span className="text-slate-500">Scan Progress</span>
                                        <span className="text-emerald-400">{scanProgress}%</span>
                                    </div>
                                    <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                                        <div
                                            className={`h-full bg-gradient-to-r from-emerald-500 via-teal-400 to-cyan-400 transition-[width] duration-300 ${isScanning ? 'animate-pulse' : ''}`}
                                            style={{ width: `${scanProgress}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-[10px] text-slate-500 uppercase tracking-widest">
                                        {isScanning ? `Processing: ${pipelineSteps[Math.min(scanStep, pipelineSteps.length - 1)].label}` : scanProgress === 100 ? 'Scan complete' : 'Ready to scan'}
                                    </p>
                                </div>

                                <div className="space-y-3">
                                    {pipelineSteps.map((step, idx) => (
                                        <div
                                            key={idx}
                                            className={`flex items-center gap-4 p-3 rounded-xl border transition-all ${
                                                scanStep === idx && isScanning
                                                    ? 'bg-emerald-500/10 border-emerald-500/30 shadow-[0_0_20px_rgba(16,185,129,0.15)]'
                                                    : 'border-slate-800'
                                            }`}
                                        >
                                            <div className="flex flex-col items-center">
                                                <div className={`resnet-node ${scanStep >= idx ? 'active' : ''}`}></div>
                                                {idx < 4 && <div className={`resnet-line w-0.5 h-8 my-1 ${scanStep > idx ? 'active' : 'bg-slate-700'}`}></div>}
                                            </div>
                                            <div className={scanStep === idx ? 'text-emerald-400' : scanStep > idx ? 'text-emerald-600' : 'text-slate-600'}>
                                                <p className="font-bold text-sm">{step.label}</p>
                                                <p className="text-[10px] uppercase tracking-widest">{step.detail}</p>
                                            </div>
                                            {scanStep > idx && getIcon('Check')({ size: 14, className: "ml-auto text-emerald-500" })}
                                            {scanStep === idx && isScanning && getIcon('Zap')({ size: 14, className: "ml-auto animate-pulse text-emerald-400" })}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* High-Tech Results Modal */}
                            {analysisResult && (
                                <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-xl animate-fade-in">
                                    {/* Existing Results Modal Content */}
                                    <div className="glass-morphism max-w-2xl w-full p-8 rounded-[2rem] border-2 border-emerald-500/30 shadow-[0_0_50px_rgba(16,185,129,0.2)] animate-scale-up">
                                        <div className="flex justify-between items-center mb-8">
                                            <div className="flex items-center gap-3">
                                                <div className="p-3 bg-emerald-500 rounded-2xl text-slate-950">
                                                    {getIcon('ShieldCheck')({ size: 28 })}
                                                </div>
                                                <div>
                                                    <h3 className="text-2xl font-bold">Intelligent <span className="text-emerald-500">Diagnostic Data</span></h3>
                                                    <p className="text-slate-500 text-[10px] uppercase tracking-tighter">Diagnostic Report ID: TP-{Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setAnalysisResult(null)} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 transition-colors">
                                                {getIcon('X')({ size: 24 })}
                                            </button>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-6">
                                                <div className="aspect-video rounded-2xl overflow-hidden border border-slate-700 shadow-inner">
                                                    <img src={selectedImage} alt="result" className="w-full h-full object-cover" />
                                                </div>
                                                <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-800">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-[10px] text-slate-500 uppercase font-bold">à¸ªà¸à¸²à¸à¸°à¸£à¸°à¸à¸à¸à¸´à¹à¸§à¸¨</span>
                                                        <span className="text-[10px] text-emerald-400 font-mono italic">CONFIDENCE: {(analysisResult.confidence * 100).toFixed(1)}%</span>
                                                    </div>
                                                    <div className="text-4xl font-black text-emerald-500 tracking-tighter mb-4">{analysisResult.stage}</div>
                                                    
                                                    <div className="space-y-3 p-4 bg-emerald-500/5 rounded-xl border border-emerald-500/10 mb-2">
                                                        <div className="flex items-center gap-2 text-emerald-400">
                                                            {getIcon('Sparkles')({ size: 16 })}
                                                            <span className="text-xs font-bold uppercase tracking-widest">AI Analyst Commentary</span>
                                                        </div>
                                                        <p className="text-sm text-slate-200 leading-relaxed font-medium">
                                                            {analysisResult.explainer || analysisResult.description}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="space-y-4">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/10 group relative">
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="text-[10px] text-slate-500 uppercase font-bold">à¸à¸²à¸£à¹à¸à¸­à¸à¸à¸µà¹à¸à¸±à¸à¹à¸à¹à¸</div>
                                                            {getIcon('Info')({ size: 10, className: "text-slate-600 cursor-help" })}
                                                        </div>
                                                        <div className="text-xl font-bold text-emerald-400">{analysisResult.metrics.carbon_tco2} <span className="text-[10px] text-slate-500">tCOâe</span></div>
                                                        <div className="absolute bottom-full left-0 mb-2 w-48 p-2 bg-slate-800 text-[10px] text-slate-300 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-slate-700 z-50 shadow-2xl">
                                                            à¸à¸±à¸§à¹à¸¥à¸à¸à¸µà¹à¹à¸ªà¸à¸à¸à¸¶à¸à¸à¸£à¸´à¸¡à¸²à¸à¸à¹à¸²à¸à¸à¸²à¸£à¹à¸à¸­à¸à¹à¸à¸­à¸­à¸à¹à¸à¸à¹à¸à¸µà¹à¸à¹à¸²à¸à¸¸à¸à¸à¸µà¹à¸à¹à¸§à¸¢à¸à¸¹à¸à¸à¸±à¸à¹à¸§à¹ à¹à¸¡à¹à¹à¸«à¹à¸¥à¸­à¸¢à¹à¸à¸à¸³à¹à¸«à¹à¹à¸¥à¸à¸£à¹à¸­à¸à¸à¸£à¸±à¸
                                                        </div>
                                                    </div>
                                                    <div className="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/10 group relative">
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="text-[10px] text-slate-500 uppercase font-bold">à¸à¸±à¸à¸à¸µà¸¡à¸§à¸¥à¸à¸µà¸§à¸ à¸²à¸</div>
                                                            {getIcon('Info')({ size: 10, className: "text-slate-600 cursor-help" })}
                                                        </div>
                                                        <div className="text-xl font-bold text-emerald-400">{analysisResult.metrics.biomass_index} <span className="text-[10px] text-slate-500">INDEX</span></div>
                                                        <div className="absolute bottom-full left-0 mb-2 w-48 p-2 bg-slate-800 text-[10px] text-slate-300 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-slate-700 z-50 shadow-2xl">
                                                            à¸à¹à¸²à¸à¸§à¸²à¸¡à¸«à¸à¸²à¹à¸à¹à¸à¸à¸­à¸à¸à¹à¸à¹à¸¡à¹à¹à¸¥à¸°à¸ªà¸´à¹à¸à¸¡à¸µà¸à¸µà¸§à¸´à¸ à¸¢à¸´à¹à¸à¸ªà¸¹à¸à¹à¸à¸¥à¸§à¹à¸²à¸à¹à¸²à¸¡à¸µà¸à¸§à¸²à¸¡à¸­à¸¸à¸à¸¡à¸ªà¸¡à¸à¸¹à¸£à¸à¹à¸¡à¸²à¸à¸à¸£à¸±à¸
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="space-y-3">
                                                    <p className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">à¸à¹à¸²à¸à¸±à¸§à¸à¸µà¹à¸§à¸±à¸à¸à¸§à¸²à¸¡à¸­à¸¸à¸à¸¡à¸ªà¸¡à¸à¸¹à¸£à¸à¹</p>
                                                    {[
                                                        { label: 'NDVI Vegetation Health', value: 88 },
                                                        { label: 'Species Density Index', value: 74 },
                                                        { label: 'Soil Organic Carbon', value: 65 }
                                                    ].map((item, i) => (
                                                        <div key={i} className="bg-slate-900/30 p-3 rounded-xl border border-slate-800">
                                                            <div className="flex justify-between text-[10px] mb-1">
                                                                <span className="text-slate-400 uppercase font-bold tracking-tight">{item.label}</span>
                                                                <span className="text-white font-bold">{item.value}%</span>
                                                            </div>
                                                            <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                                                <div className={`h-full bg-emerald-500 rounded-full opacity-80`} style={{ width: `${item.value}%` }}></div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="flex gap-4">
                                                    <button 
                                                        onClick={() => {
                                                            const text = `ð TerraPulse AI Analysis Report\nStage: ${analysisResult.stage}\nInsight: ${analysisResult.explainer}\nCarbon: ${analysisResult.metrics.carbon_tco2} tCO2e\nBiomass: ${analysisResult.metrics.biomass_index}\n#TerraPulse #BlueCarbon`;
                                                            navigator.clipboard.writeText(text);
                                                            setNotify({ message: 'Summary copied to clipboard! Share it with your friends.', type: 'success' });
                                                        }}
                                                        className="flex-1 mt-4 bg-slate-800 text-slate-300 font-bold py-4 rounded-2xl hover:bg-slate-700 transition-all flex items-center justify-center gap-2 border border-slate-700"
                                                    >
                                                        {getIcon('Share2')({ size: 18 })}
                                                        <span>Share Insights</span>
                                                    </button>
                                                    <button 
                                                        onClick={() => {
                                                            setNotify({ message: 'Full report exported successfully.', type: 'success' });
                                                            setAnalysisResult(null);
                                                        }}
                                                        className="flex-[1.5] mt-4 bg-emerald-500 text-slate-900 font-bold py-4 rounded-2xl hover:bg-emerald-400 transition-all flex items-center justify-center gap-2 shadow-xl shadow-emerald-500/40"
                                                    >
                                                        {getIcon('FileText')({ size: 18 })}
                                                        <span>Export Report</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const DigitalEcosystem = ({ history }) => {
            const [ecosystemStage, setEcosystemStage] = useState(1);
            const [progress, setProgress] = useState(0);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const [evolutionLog, setEvolutionLog] = useState([]);
            const intervalRef = useRef(null);

            const stages = [
                { name: 'Blue Larva', description: 'à¸ªà¸±à¸à¸à¸²à¸à¹à¸£à¸´à¹à¸¡à¸à¹à¸à¸à¸­à¸à¸à¸µà¸§à¸´à¸à¹à¸à¹à¸à¸°à¹à¸¥', targetProgress: 20, duration: 10000, icon: 'Waves' },
                { name: 'Carbon Shell', description: 'à¹à¸£à¸´à¹à¸¡à¸ªà¸£à¹à¸²à¸à¹à¸à¸£à¸²à¸°à¸à¸¸à¹à¸¡à¸à¸±à¸à¸à¸²à¸à¸à¸²à¸£à¹à¸à¸­à¸', targetProgress: 40, duration: 15000, icon: 'Shield' },
                { name: 'Cyan Jellyfish', description: 'à¸¥à¹à¸­à¸à¸¥à¸­à¸¢à¹à¸¥à¸°à¸à¸¹à¸à¸à¸±à¸à¸à¸­à¸à¹à¸ªà¸µà¸¢à¹à¸à¸à¹à¸³', targetProgress: 60, duration: 20000, icon: 'Wind' },
                { name: 'Emerald Ray', description: 'à¸à¸¹à¹à¸à¸´à¸à¸±à¸à¸©à¹à¹à¸à¸§à¸à¹à¸²à¸ªà¸µà¹à¸à¸µà¸¢à¸§à¹à¸à¹à¸¡', targetProgress: 80, duration: 25000, icon: 'Zap' },
                { name: 'Maritime Guardian', description: 'à¹à¸à¸à¸à¸´à¸à¸±à¸à¸©à¹à¹à¸«à¹à¸à¸à¸¥à¸¹à¸à¸²à¸£à¹à¸à¸­à¸ (Evolution Peak)', targetProgress: 100, duration: 30000, icon: 'Crown' },
            ];

            const currentStageData = stages[ecosystemStage - 1];

            // Calculate influence from history
            const historyInfluence = useMemo(() => {
                if (!history || !Array.isArray(history) || history.length === 0) return 0;
                const totalConfidence = history.reduce((sum, item) => sum + (item.confidence || 0), 0);
                const avgConfidence = totalConfidence / history.length;
                return Math.min(avgConfidence / 0.95, 1) * 0.1; // Max 10% boost
            }, [history]);

            useEffect(() => {
                intervalRef.current = setInterval(() => {
                    setProgress(prevProgress => {
                        if (ecosystemStage >= stages.length) {
                            clearInterval(intervalRef.current);
                            return 100;
                        }

                        const stageDuration = currentStageData.duration;
                        const timeElapsed = (new Date() - lastUpdate) / 1000; // seconds
                        const progressPerSecond = (currentStageData.targetProgress - (stages[ecosystemStage - 2]?.targetProgress || 0)) / (stageDuration / 1000);
                        
                        let newProgress = prevProgress + (progressPerSecond * 0.25) * (1 + historyInfluence); // 250ms update
                        newProgress = Math.min(newProgress, currentStageData.targetProgress);

                        if (newProgress >= currentStageData.targetProgress && ecosystemStage < stages.length) {
                            setEcosystemStage(prevStage => {
                                const nextStage = prevStage + 1;
                                setEvolutionLog(prevLog => [...prevLog, {
                                    timestamp: new Date().toLocaleString(),
                                    message: `Ecosystem evolved to ${stages[prevStage].name}!`
                                }]);
                                setLastUpdate(new Date());
                                return nextStage;
                            });
                            return currentStageData.targetProgress; // Ensure progress is exactly at target before next stage
                        }
                        return newProgress;
                    });
                }, 250); // Update every 250ms

                return () => clearInterval(intervalRef.current);
            }, [ecosystemStage, lastUpdate, historyInfluence]);

            return (
                <div className="space-y-8 animate-fade-in relative z-10">
                    <header className="space-y-2">
                        <h2 className="text-4xl font-extrabold text-white">Digital <span className="text-emerald-500">Ecosystem Evolution</span></h2>
                        <p className="text-slate-400 text-lg">Simulating the growth and health of your Blue Carbon ecosystem based on historical data.</p>
                    </header>

                    <div className="glass-morphism p-8 rounded-[2rem] border border-slate-800 flex flex-col lg:flex-row items-center gap-8">
                        <div className="flex-1 text-center space-y-4">
                            <div className="relative group w-64 h-64 mx-auto flex items-center justify-center mb-6">
                                {/* outer rotating ring */}
                                <div className="absolute inset-0 border-2 border-dashed border-emerald-500/20 rounded-full animate-spin-slow"></div>
                                {/* middle tech ring */}
                                <div className="absolute inset-4 border border-emerald-500/30 rounded-full before:content-[''] before:absolute before:-top-1 before:left-1/2 before:-translate-x-1/2 before:w-2 before:h-2 before:bg-emerald-500 before:rounded-full before:shadow-[0_0_10px_#10B981]"></div>
                                {/* Inner glow and icon container */}
                                <div className="w-48 h-48 rounded-full bg-slate-950/80 border-2 border-emerald-500/50 flex items-center justify-center relative shadow-[0_0_50px_rgba(16,185,129,0.2)] overflow-hidden group-hover:border-emerald-400 transition-all duration-700">
                                    <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent"></div>
                                    <div className="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
                                        <div className="w-full h-px bg-emerald-500/50 scale-x-150 rotate-45"></div>
                                        <div className="w-full h-px bg-emerald-500/50 scale-x-150 -rotate-45"></div>
                                    </div>
                                    <div className="relative z-10 drop-shadow-[0_0_15px_rgba(16,185,129,0.8)] animate-float">
                                        {getIcon(currentStageData.icon)({ size: 80, className: "text-emerald-400" })}
                                    </div>
                                </div>
                                {/* Telemetry labels */}
                                <div className="absolute top-0 right-0 p-2 bg-slate-900 border border-emerald-500/30 rounded-lg text-[8px] font-black text-emerald-500 uppercase rotate-12 -translate-y-4">Stable</div>
                                <div className="absolute bottom-0 left-0 p-2 bg-slate-900 border border-emerald-500/30 rounded-lg text-[8px] font-black text-emerald-500 uppercase -rotate-12 translate-y-4">Sync: Bio-Core</div>
                            </div>
                            <h3 className="text-3xl font-black text-emerald-400">{currentStageData.name}</h3>
                            <p className="text-slate-400 text-sm">{currentStageData.description}</p>
                            <div className="text-xs text-slate-500 uppercase font-bold">
                                Current Progress: {progress.toFixed(1)}%
                            </div>
                            <ProgressBar value={progress} color="#10B981" />
                            {ecosystemStage < stages.length && (
                                <p className="text-xs text-slate-600 mt-2">Next stage: {stages[ecosystemStage].name} at {stages[ecosystemStage].targetProgress}% progress.</p>
                            )}
                            {historyInfluence > 0 && (
                                <p className="text-xs text-emerald-500 font-bold">
                                    +{ (historyInfluence * 100).toFixed(1) }% growth boost from analysis history!
                                </p>
                            )}
                        </div>

                        <div className="w-px h-64 bg-slate-800 hidden lg:block"></div>

                        <div className="flex-1 space-y-4 w-full lg:w-auto">
                            <h4 className="text-xl font-bold flex items-center gap-2">
                                {getIcon('Activity')({ size: 20, className: "text-emerald-500" })}
                                Evolution Log
                            </h4>
                            <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 h-64 overflow-y-auto custom-scrollbar">
                                {evolutionLog.length === 0 ? (
                                    <p className="text-slate-600 text-sm">No events yet. Evolution starting...</p>
                                ) : (
                                    <ul className="space-y-2">
                                        {evolutionLog.map((entry, index) => {
                                            const timePart = entry.timestamp.includes(',') 
                                                ? entry.timestamp.split(',')[1].trim() 
                                                : entry.timestamp.split(' ').slice(-1)[0];
                                            return (
                                                <li key={index} className="flex items-start gap-2 text-xs text-slate-400">
                                                    <span className="text-emerald-500">{getIcon('ChevronRight')({ size: 14 })}</span>
                                                    <span className="font-mono text-slate-600 shrink-0">[{timePart}]</span>
                                                    <span>{entry.message}</span>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </div>
                            <button 
                                onClick={() => {
                                    setEcosystemStage(1);
                                    setProgress(0);
                                    setLastUpdate(new Date());
                                    setEvolutionLog([]);
                                }}
                                className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-bold rounded-xl transition-colors flex items-center justify-center gap-2 border border-slate-700"
                            >
                                {getIcon('RefreshCcw')({ size: 16 })}
                                Reset Ecosystem
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CarbonMarket = () => {
            const [marketData, setMarketData] = useState([
                { name: 'VCS Carbon Standard', price: 12.45, change: '+1.2%', vol: '24M' },
                { name: 'Gold Standard (GS)', price: 18.90, change: '+0.8%', vol: '12M' },
                { name: 'Blue Carbon Credit', price: 42.15, change: '+4.5%', vol: '8.4M' },
                { name: 'EUA Carbon Allowance', price: 68.30, change: '-2.1%', vol: '150M' },
                { name: 'Swiss Carbon Offset', price: 92.00, change: '+0.4%', vol: '5.2M' },
            ]);

            useEffect(() => {
                const interval = setInterval(() => {
                    setMarketData(prev => prev.map(m => ({
                        ...m,
                        price: +(m.price + (Math.random() - 0.48) * 0.5).toFixed(2),
                        change: (Math.random() > 0.5 ? '+' : '-') + (Math.random() * 2).toFixed(1) + '%'
                    })));
                }, 8000); // Efficient Update (8s)
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="space-y-8 animate-fade-in">
                    <header>
                        <h2 className="text-3xl font-bold">Carbon <span className="text-emerald-500">Asset Exchange</span></h2>
                        <p className="text-slate-400">Real-time monitoring of global environmental asset prices and carbon credits.</p>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {marketData.map((m, i) => (
                            <div key={i} className="glass-morphism p-6 rounded-2xl flex flex-col justify-between micro-interaction h-44">
                                <div className="flex justify-between items-start">
                                    <span className="font-bold text-slate-200">{m.name}</span>
                                    <span className={`text-xs font-bold ${m.change.includes('+') ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {m.change}
                                    </span>
                                </div>
                                <div className="mt-4">
                                    <div className="text-3xl font-bold tracking-tight">${m.price.toFixed(2)}</div>
                                    <div className="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Volume: {m.vol}</div>
                                </div>
                                <div className="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden mt-4">
                                    <div className="bg-emerald-600 h-full rounded-full" style={{ width: `${Math.random() * 60 + 20}%` }}></div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="glass-morphism rounded-2xl overflow-hidden overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-emerald-500/10 text-emerald-400">
                                <tr>
                                    <th className="p-4">Asset Class</th>
                                    <th className="p-4 text-right">Latest Price</th>
                                    <th className="p-4 text-right">24h Change</th>
                                    <th className="p-4 text-right">Market Cap</th>
                                    <th className="p-4">Trend</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {marketData.map((m, i) => (
                                    <tr key={i} className="hover:bg-slate-800/50 transition-colors">
                                        <td className="p-4 font-semibold">{m.name}</td>
                                        <td className="p-4 text-right font-bold tracking-tight">${m.price.toFixed(2)}</td>
                                        <td className={`p-4 text-right font-bold ${m.change.includes('+') ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {m.change}
                                        </td>
                                        <td className="p-4 text-right text-slate-400 font-mono tracking-tighter">{(m.price * 10).toFixed(0)}B</td>
                                        <td className="p-4">
                                            <div className={`w-2 h-2 rounded-full ${m.change.includes('+') ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]'}`}></div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const History = ({ history, onDelete, onClear }) => {
            return (
                <div className="space-y-8 animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold flex items-center gap-2">
                                        {getIcon('History')({ size: 20, className: "text-emerald-500" })}
                                        Data Analysis History
                                    </h3>
                                    {history.length > 0 && (
                                        <button 
                                            onClick={onClear}
                                            className="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                                        >
                                            {getIcon('Trash2')({ size: 14 })}
                                            Clear All History
                                        </button>
                                    )}
                                </div>

                    {history.length === 0 ? (
                        <div className="glass-morphism p-12 rounded-2xl text-center">
                            <div className="bg-slate-800/50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                {getIcon('History')({ size: 40, className: "text-slate-600" })}
                            </div>
                            <p className="text-slate-500 font-medium">No analysis history available.</p>
                            <p className="text-slate-600 text-sm mt-1">Start scanning your areas to save them to the database.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {history.slice().reverse().map((item) => (
                                <div key={item.id} className="glass-morphism rounded-2xl overflow-hidden flex flex-col group border border-transparent hover:border-emerald-500/30 transition-all">
                                    <div className="h-48 relative overflow-hidden">
                                        <img src={item.image} className="w-full h-full object-cover grayscale-[0.5] group-hover:grayscale-0 transition-all duration-500" />
                                        <div className="absolute top-4 right-4 bg-slate-900/80 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-emerald-400 border border-emerald-500/20">
                                            {item.date}
                                        </div>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <h3 className="text-xl font-bold uppercase tracking-tighter text-emerald-400">{item.stage}</h3>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <p className="text-[10px] text-slate-500 font-medium uppercase tracking-widest">Confidence: {(item.confidence * 100).toFixed(1)}%</p>
                                                    <div className="flex items-center gap-1 px-1.5 py-0.5 bg-emerald-500/10 rounded-md border border-emerald-500/20">
                                                        <div className="w-1 h-1 bg-emerald-500 rounded-full animate-pulse"></div>
                                                        <span className="text-[8px] text-emerald-500 font-black uppercase tracking-tighter">Verified on Polygon</span>
                                                    </div>
                                                </div>
                                                <p className="text-[8px] font-mono text-slate-600 truncate max-w-[180px]">TX: 0x{Math.random().toString(16).substr(2, 40)}</p>
                                            </div>
                                            <button onClick={() => onDelete(item.id)} className="p-2 hover:bg-red-500/10 rounded-lg text-slate-600 hover:text-red-400 transition-colors">
                                                {getIcon('Trash2')({ size: 18 })}
                                            </button>
                                        </div>
                                        <p className="text-sm text-slate-400 leading-relaxed italic">"{item.description}"</p>
                                        
                                        {item.explainer && (
                                            <div className="space-y-2 p-3 bg-emerald-500/5 rounded-xl border border-emerald-500/10">
                                                <div className="flex items-center gap-2 text-emerald-400">
                                                    {getIcon('Sparkles')({ size: 12 })}
                                                    <span className="text-[10px] font-bold uppercase tracking-widest">AI Analyst Context</span>
                                                </div>
                                                <p className="text-xs text-slate-300 leading-relaxed">{item.explainer}</p>
                                            </div>
                                        )}

                                        <div className="flex gap-2 pt-2">
                                            <button 
                                                onClick={() => {
                                                    const text = `ð TerraPulse Report\nDate: ${item.date}\nStage: ${item.stage}\nImpact: ${item.explainer || item.description}\n#TerraPulse`;
                                                    navigator.clipboard.writeText(text);
                                                    setNotify({ message: 'Summary copied to clipboard!', type: 'success' });
                                                }}
                                                className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold py-2 rounded-lg border border-slate-700 transition-all flex items-center justify-center gap-2"
                                            >
                                                {getIcon('Share2')({ size: 14 })}
                                                Share
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    const text = ` TerraPulse - Analysis Report\nDate: ${item.date}\nStage: ${item.stage}\nConfidence: ${item.confidence}\nCarbon: ${item.metrics.carbon_tco2}\nBiomass: ${item.metrics.biomass_index}\nDescription: ${item.description}\nExpert Insight: ${item.explainer || 'N/A'}`;
                                                    const blob = new Blob([text], { type: 'text/plain' });
                                                    const url = URL.createObjectURL(blob);
                                                    const a = document.createElement('a');
                                                    a.href = url;
                                                    a.download = `terrapulse_report_${item.id}.txt`;
                                                    a.click();
                                                }}
                                                className="flex-[1.5] bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 text-xs font-bold py-2 rounded-lg border border-emerald-500/20 transition-all flex items-center justify-center gap-2"
                                            >
                                                {getIcon('Download')({ size: 14 })}
                                                Download
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Chatbot = ({ setNotify }) => {
            const [messages, setMessages] = useState([
                { role: 'bot', text: 'Welcome to TerraPulse AI Advisor. I am a specialist in SDG 13 (Climate Action) and Blue Carbon economics. How can I assist you today?' }
            ]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const chatBoxRef = useRef(null);

            useEffect(() => {
                if (chatBoxRef.current) {
                    chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
                }
            }, [messages, isTyping]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userText = input;
                setInput('');
                setMessages(prev => [...prev, { role: 'user', text: userText }]);
                setIsTyping(true);

                try {
                    const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `You are an environmental expert for TerraPulse Pro.
                                Provide professional, insightful, and evidence-based answers regarding SDG 13, carbon credits, or climate conditions.
                                Respond ONLY in "English" and keep the summary concise (max 100 words).
                                User Question: ${userText}` }]
                            }]
                        })
                    });

                    const botReply = response.candidates[0].content.parts[0].text;
                    setMessages(prev => [...prev, { role: 'bot', text: botReply }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'bot', text: "à¸à¸­à¸­à¸ à¸±à¸¢ à¸£à¸°à¸à¸à¹à¸¡à¹à¸ªà¸²à¸¡à¸²à¸£à¸à¹à¸à¸·à¹à¸­à¸¡à¸à¹à¸­à¹à¸à¹à¹à¸à¸à¸à¸°à¸à¸µà¹ à¹à¸à¸£à¸à¸¥à¸­à¸à¹à¸«à¸¡à¹à¸­à¸µà¸à¸à¸£à¸±à¹à¸à¹à¸à¸ à¸²à¸¢à¸«à¸¥à¸±à¸" }]);
                    setNotify({ message: 'à¹à¸à¸´à¸à¸à¹à¸­à¸à¸´à¸à¸à¸¥à¸²à¸à¹à¸à¸à¸£à¸´à¸à¸²à¸£à¹à¸à¸', type: 'error' });
                } finally {
                    setIsTyping(false);
                }
            };

            return (
                <div className="flex flex-col h-[600px] animate-fade-in max-w-4xl mx-auto w-full">
                    <header className="mb-6">
                        <h2 className="text-3xl font-bold flex items-center gap-3">
                            à¸à¸µà¹à¸à¸£à¸¶à¸à¸©à¸² <span className="text-emerald-500">AI</span>
                            <span className="text-xs bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/20">à¸­à¸­à¸à¹à¸¥à¸à¹</span>
                        </h2>
                    </header>
                    
                    <div className="flex-1 glass-morphism rounded-2xl overflow-hidden flex flex-col">
                        <div ref={chatBoxRef} className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-4 rounded-2xl ${
                                        m.role === 'user' 
                                        ? 'bg-emerald-600 text-slate-900 font-medium rounded-tr-none' 
                                        : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none'
                                    }`}>
                                        <p className="text-sm leading-relaxed">{m.text}</p>
                                    </div>
                                </div>
                            ))}
                            {isTyping && (
                                <div className="flex justify-start">
                                    <div className="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700">
                                        <div className="flex gap-1">
                                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce"></div>
                                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 border-t border-slate-800 bg-slate-900/50">
                            <div className="flex gap-3">
                                <input 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="à¸ªà¸­à¸à¸à¸²à¸¡à¸à¹à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹à¸à¸­à¸à¹à¸à¸£à¸à¸´à¸ à¸«à¸£à¸·à¸­ SDG 13..."
                                    className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40 transition-all"
                                />
                                <button 
                                    onClick={handleSend}
                                    className="p-3 bg-emerald-500 text-slate-900 rounded-xl hover:bg-emerald-400 transition-colors shadow-lg shadow-emerald-500/20"
                                >
                                    {getIcon('Send')({ size: 20 })}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const SubscriptionPlans = () => {
            const plans = [
                {
                    tier: 'Basic Plan',
                    target: 'Beginners / NGOs / Students',
                    price: '$0',
                    features: [
                        'Analyze up to 100 Rai (16 Hectares)',
                        'Bi-weekly updates (Sentinel-2 Data)',
                        'Summary Forest Stage Reports',
                        'Basic Carbon Sequestration Charts'
                    ],
                    icon: 'BookOpen',
                    color: 'text-slate-400',
                    border: 'border-slate-800'
                },
                {
                    tier: 'Enterprise Plan',
                    target: 'Large Corps / ESG Corporate',
                    price: 'Custom',
                    features: [
                        'Unlimited Analysis (Multi-site Management)',
                        'High-Res Satellite (0.3m - 0.5m)',
                        'Investor Relations Dashboard',
                        'API Endpoint Integration',
                        'Quarterly Carbon Expert Consultations'
                    ],
                    icon: 'Crown',
                    color: 'text-emerald-400',
                    border: 'border-emerald-500/30',
                    highlight: true
                }
            ];

            return (
                <div className="space-y-12 animate-fade-in relative z-10">
                    <header className="text-center max-w-2xl mx-auto space-y-4">
                        <h2 className="text-4xl font-black italic tracking-tighter">SCALABLE <span className="text-emerald-500">INTELLIGENCE</span></h2>
                        <p className="text-slate-400">Choose the intelligence tier that fits your environmental mission scope.</p>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
                        {plans.map((plan, i) => (
                            <div key={i} className={`glass-morphism p-10 rounded-[3rem] border ${plan.border} flex flex-col relative overflow-hidden group hover:scale-[1.02] transition-all`}>
                                {plan.highlight && (
                                    <div className="absolute top-0 right-0 bg-emerald-500 text-slate-900 text-[10px] font-black px-6 py-2 rounded-bl-3xl uppercase tracking-tighter">Recommended</div>
                                )}
                                <div className="flex justify-between items-start mb-8">
                                    <div className={`p-4 bg-slate-800/50 rounded-3xl ${plan.color}`}>
                                        {getIcon(plan.icon)({ size: 32 })}
                                    </div>
                                    <div className="text-right">
                                        <div className="text-3xl font-black tracking-tight">{plan.price}</div>
                                        <div className="text-[10px] text-slate-500 uppercase font-bold">per month</div>
                                    </div>
                                </div>
                                <h3 className={`text-2xl font-black mb-2 ${plan.color}`}>{plan.tier}</h3>
                                <p className="text-xs text-slate-400 mb-8 font-medium italic">{plan.target}</p>
                                
                                <ul className="space-y-4 mb-10 flex-1">
                                    {plan.features.map((f, j) => (
                                        <li key={j} className="flex gap-3 text-sm text-slate-300 items-center">
                                            <div className="w-5 h-5 rounded-full bg-emerald-500/10 flex items-center justify-center shrink-0">
                                                {getIcon('Check')({ size: 12, className: "text-emerald-500" })}
                                            </div>
                                            {f}
                                        </li>
                                    ))}
                                </ul>

                                <button className={`w-full py-4 rounded-2xl font-black uppercase tracking-widest text-xs transition-all ${
                                    plan.highlight 
                                    ? 'bg-emerald-500 text-slate-900 shadow-xl shadow-emerald-500/20 hover:bg-emerald-400' 
                                    : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                                }`}>
                                    Activate Tier
                                </button>
                            </div>
                        ))}
                    </div>

                    <div className="glass-morphism p-8 rounded-[2rem] max-w-5xl mx-auto border-emerald-500/10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div className="flex gap-4 items-center">
                            <div className="p-3 bg-emerald-500/10 rounded-2xl">
                                {getIcon('LifeBuoy')({ size: 24, className: "text-emerald-500" })}
                            </div>
                            <div>
                                <h4 className="font-bold">Need a Custom Mission Scope?</h4>
                                <p className="text-xs text-slate-500">Contact our climate scientists for government or large-scale restoration projects.</p>
                            </div>
                        </div>
                        <button className="px-8 py-3 bg-white text-slate-900 font-bold rounded-xl text-sm hover:invert transition-all">Support Center</button>
                    </div>
                </div>
            );
        };

        const FeatureIllustration = ({ type, color }) => {
            const icons = {
                'Digital Twin': 'Layers',
                'AI Scanner': 'Satellite',
                'NFT Evolution': 'Zap',
                'Blockchain': 'ShieldCheck'
            };
            const iconName = icons[type] || 'Star';
            
            return (
                <div className="relative w-full h-24 mb-6 flex items-center justify-center overflow-hidden rounded-2xl bg-slate-950/60 border border-slate-800">
                    {/* Background Tech Pattern */}
                    <div className="absolute inset-0 opacity-15 bg-[linear-gradient(rgba(16,185,129,0.2)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.2)_1px,transparent_1px)] bg-[size:15px_15px]"></div>
                    <div className="absolute -left-10 top-0 w-24 h-full bg-gradient-to-r from-transparent via-emerald-400/20 to-transparent skew-x-12 animate-showcase-scan"></div>
                    
                    {/* Abstract Shapes based on type */}
                    <div className="absolute inset-0 flex items-center justify-center">
                        {type === 'Digital Twin' && (
                            <div className="relative w-20 h-20 rounded-2xl border border-blue-500/30 bg-blue-500/5 overflow-hidden animate-showcase-float">
                                <div className="absolute inset-2 grid grid-cols-3 gap-1">
                                    {[...Array(9)].map((_, i) => (
                                        <div key={i} className="rounded-sm border border-blue-500/30 bg-blue-500/10"></div>
                                    ))}
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <div className="w-2 h-2 bg-emerald-300 rounded-full animate-showcase-orbit"></div>
                                </div>
                            </div>
                        )}
                        {type === 'AI Scanner' && (
                            <>
                                <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500/40 animate-scan"></div>
                                <div className="w-14 h-14 rounded-full border border-emerald-500/25 relative">
                                    <div className="absolute inset-2 rounded-full border border-emerald-400/30"></div>
                                    <div className="absolute w-1 h-1 bg-emerald-300 rounded-full top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                                </div>
                            </>
                        )}
                        {type === 'NFT Evolution' && (
                            <div className="relative w-16 h-16">
                                <div className="absolute inset-0 bg-yellow-500/10 blur-xl rounded-full animate-pulse-slow"></div>
                                <div className="absolute left-3 top-5 w-4 h-4 rounded-full border border-yellow-400/40 bg-yellow-400/10 animate-showcase-float"></div>
                                <div className="absolute right-3 top-7 w-3 h-3 rounded-full border border-yellow-300/40 bg-yellow-300/10 animate-showcase-float [animation-delay:0.4s]"></div>
                            </div>
                        )}
                        {type === 'Blockchain' && (
                            <div className="flex gap-1.5 items-center">
                                {[1,2,3].map(i => (
                                    <div key={i} className="w-3 h-3 bg-purple-500/20 border border-purple-500/40 rotate-45 animate-showcase-float" style={{ animationDelay: `${i * 0.2}s` }}></div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Main Icon */}
                    <div className={`relative z-10 transition-transform duration-500 group-hover:scale-110 ${color}`}>
                        {getIcon(iconName)({ size: 40, strokeWidth: 1.5 })}
                    </div>
                </div>
            );
        };

        const PrototypeShowcase = () => {
            const features = [
                { title: 'Digital Twin', desc: '2D Mapping & Sensors', color: 'text-blue-400', badge: 'ResNet-50' },
                { title: 'AI Scanner', desc: 'Satellite & Bio-Acoustics', color: 'text-emerald-400', badge: 'Gemini 2.0' },
                { title: 'NFT Evolution', desc: 'Gamified Carbon Sequestration', color: 'text-yellow-400', badge: 'Gen Z Hook' },
                { title: 'Blockchain', desc: 'Data Integrity & Polygon Ledger', color: 'text-purple-400', badge: 'Verified' }
            ];

            return (
                <div className="space-y-8 animate-fade-in py-6 relative">
                    <div className="absolute inset-x-0 top-0 h-56 pointer-events-none">
                        <div className="absolute left-10 top-3 w-36 h-36 bg-emerald-500/10 blur-3xl rounded-full animate-showcase-float"></div>
                        <div className="absolute right-12 top-12 w-28 h-28 bg-blue-500/10 blur-3xl rounded-full animate-showcase-float [animation-delay:0.6s]"></div>
                    </div>

                    <header className="text-center space-y-3 relative z-10">
                        <div className="inline-flex items-center gap-2 px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                            <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            <span className="text-[8px] font-black text-emerald-500 uppercase tracking-widest">Showcase Mode</span>
                        </div>
                        <h2 className="text-4xl font-black text-white">Project <span className="text-emerald-500 italic">Highlights</span></h2>
                        <p className="text-slate-500 text-sm">Innovations & Core Technologies in TerraPulse AI</p>
                        <div className="flex flex-wrap justify-center gap-2 pt-1">
                            {[
                                { l: 'Live Modules', v: '04' },
                                { l: 'Pipeline Latency', v: '0.8s' },
                                { l: 'Showcase Uptime', v: '99.98%' }
                            ].map((stat, idx) => (
                                <div key={stat.l} className="px-3 py-1.5 rounded-lg bg-slate-900/70 border border-slate-800 flex items-center gap-2 animate-showcase-pop" style={{ animationDelay: `${idx * 120}ms` }}>
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                                    <span className="text-[8px] uppercase tracking-widest text-slate-500 font-black">{stat.l}</span>
                                    <span className="text-[10px] uppercase tracking-wide text-emerald-400 font-black">{stat.v}</span>
                                </div>
                            ))}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 max-w-7xl mx-auto">
                        {features.map((f, i) => (
                            <div
                                key={i}
                                className="glass-morphism p-6 rounded-[2.5rem] border border-slate-800 flex flex-col items-center text-center group hover:border-emerald-500/40 hover:-translate-y-1 transition-all duration-300 relative overflow-hidden animate-showcase-pop"
                                style={{ animationDelay: `${i * 120}ms` }}
                            >
                                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none">
                                    <div className="absolute -inset-x-20 top-0 h-1/2 bg-gradient-to-r from-transparent via-emerald-400/15 to-transparent skew-x-12 animate-showcase-scan"></div>
                                </div>
                                <FeatureIllustration type={f.title} color={f.color} />
                                
                                <span className="px-2 py-0.5 bg-slate-900 border border-slate-800 rounded text-[8px] font-black text-slate-500 uppercase tracking-widest mb-2">{f.badge}</span>
                                <h3 className="text-lg font-black text-white mb-1">{f.title}</h3>
                                <p className="text-slate-500 text-[10px] leading-tight mb-4">{f.desc}</p>
                                <div className="mt-auto w-full pt-4 border-t border-slate-800/50 flex justify-center">
                                    <div className="flex items-center gap-1.5">
                                        <div className="w-1 h-1 bg-emerald-500 rounded-full"></div>
                                        <span className="text-[8px] font-bold text-slate-600 uppercase">Operational</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="max-w-4xl mx-auto glass-morphism p-6 rounded-[2.5rem] border border-emerald-500/10 flex items-center justify-between gap-6 relative overflow-hidden">
                        <div className="absolute -left-10 top-0 w-40 h-40 bg-emerald-500/10 blur-3xl rounded-full animate-showcase-float"></div>
                        <div className="flex items-center gap-4 text-left">
                            <div className="p-3 bg-emerald-500/10 rounded-2xl border border-emerald-500/20">
                                {getIcon('MonitorPlay')({ size: 24, className: "text-emerald-400" })}
                            </div>
                            <div>
                                <h4 className="text-sm font-black text-white uppercase italic">Pitch-Ready System</h4>
                                <p className="text-[10px] text-slate-500">Integrated Environmental Intelligence for Gen Z Conservation.</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <div className="px-4 py-2 bg-slate-900 rounded-xl border border-slate-800 text-[9px] font-black text-slate-400 uppercase tracking-widest cursor-default">v2.2 Stable</div>
                            <div className="px-4 py-2 bg-emerald-500 text-slate-900 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg shadow-emerald-500/20 cursor-default">Verified</div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [notify, setNotify] = useState({ message: '', type: '' });

            useEffect(() => {
                console.log("[App] TerraPulse Core V2.0 Initialized");
            }, [activeTab]);
            const [history, setHistory] = useState(() => {
                try {
                    const saved = localStorage.getItem('terra_history');
                    let parsed = [];
                    try { parsed = saved ? JSON.parse(saved) : []; } catch(e) { parsed = []; }
                    if (!Array.isArray(parsed) || parsed.length === 0) {
                        // Pre-populate for Prototype/Demo
                                    return [
                                        {
                                            id: 1,
                                            date: "21/02/2026, 22:15:30",
                                            image: "./samples/mangrove_1.png",
                                            stage: "Stage IV",
                                            confidence: 0.985,
                                            metrics: { carbon_tco2: 1450, biomass_index: 0.92 },
                                            description: "Ecosystem represents peak maturity with high carbon storage capacity.",
                                            explainer: "à¸à¹à¸²à¸à¸²à¸¢à¹à¸¥à¸à¸à¸µà¹à¸ªà¸¡à¸à¸¹à¸£à¸à¹à¸à¸µà¹à¸ªà¸¸à¸! à¸à¸¸à¸à¸à¸µà¹à¸à¸³à¸«à¸à¹à¸²à¸à¸µà¹à¹à¸«à¸¡à¸·à¸­à¸ 'à¸à¸­à¸' à¹à¸¥à¸° 'à¸à¸à¸²à¸à¸²à¸£à¸à¸²à¸£à¹à¸à¸­à¸' à¸à¸µà¹à¸à¸£à¸à¸à¸¥à¸±à¸ à¸à¹à¸§à¸¢à¸à¸à¸à¹à¸­à¸à¸à¸²à¸¢à¸à¸±à¹à¸à¸à¸²à¸à¸à¸²à¸¢à¸¸à¹à¸¥à¸°à¹à¸à¹à¸à¸à¹à¸²à¸à¸à¸­à¸à¸ªà¸±à¸à¸§à¹à¸à¹à¸³à¸«à¸²à¸¢à¸²à¸à¸à¸£à¸±à¸ à¸¡à¸«à¸±à¸¨à¸à¸£à¸£à¸¢à¹à¸¡à¸²à¸!"
                                        },
                                        {
                                            id: 2,
                                            date: "21/02/2026, 21:10:15",
                                            image: "./samples/mangrove_2.png",
                                            stage: "Stage III",
                                            confidence: 0.942,
                                            metrics: { carbon_tco2: 980, biomass_index: 0.78 },
                                            description: "Estuarine restoration area showing continuous biomass accumulation.",
                                            explainer: "à¸à¸³à¸¥à¸±à¸à¸à¸·à¹à¸à¸à¸±à¸§à¹à¸à¹à¸à¸µà¹à¸¢à¸µà¹à¸¢à¸¡! à¸à¹à¸²à¸à¸¸à¸à¸à¸µà¹à¸à¸³à¸¥à¸±à¸à¹à¸à¸´à¸à¹à¸à¸­à¸¢à¹à¸²à¸à¸£à¸§à¸à¹à¸£à¹à¸§à¹à¸¥à¸°à¹à¸£à¸´à¹à¸¡à¸à¸±à¸à¹à¸à¹à¸à¸à¸²à¸£à¹à¸à¸­à¸à¹à¸à¹à¹à¸à¸à¸£à¸´à¸¡à¸²à¸à¸¡à¸²à¸ à¹à¸«à¸¡à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸à¸à¸²à¸£à¸ªà¹à¸à¹à¸ªà¸£à¸´à¸¡à¹à¸à¸£à¸à¸à¸²à¸£ ESG à¸£à¸°à¸¢à¸°à¸¢à¸²à¸§à¸à¸£à¸±à¸"
                                        }
                                    ];
                    }
                    return parsed;
                } catch (e) {
                    console.error("Storage Error:", e);
                    return [];
                }
            });

            useEffect(() => {
                localStorage.setItem('terra_history', JSON.stringify(history));
            }, [history]);

            useEffect(() => {
                const handleSave = (e) => {
                    setHistory(prev => [...prev, e.detail]);
                };
                window.addEventListener('saveAnalysis', handleSave);
                return () => window.removeEventListener('saveAnalysis', handleSave);
            }, []);

            const deleteHistory = (id) => {
                setHistory(prev => prev.filter(item => item.id !== id));
                setNotify({ message: 'Analysis history deleted', type: 'success' });
            };

            const clearHistory = () => {
                if(confirm('Confirm clear all history?')) {
                    setHistory([]);
                    setNotify({ message: 'All analysis history cleared.', type: 'success' });
                }
            };

            useEffect(() => {
                if (notify.message) {
                    const timer = setTimeout(() => setNotify({ message: '', type: '' }), 4000);
                    return () => clearTimeout(timer);
                }
            }, [notify]);

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    <Sidebar 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                        isCollapsed={isCollapsed} 
                        setIsCollapsed={setIsCollapsed} 
                    />
                    
                    <main className="flex-1 p-8 overflow-y-auto relative custom-scrollbar">
                        {/* Background Elements */}
                        <div className="fixed top-0 right-0 w-[500px] h-[500px] bg-emerald-500/5 rounded-full blur-[120px] pointer-events-none"></div>
                        <div className="fixed bottom-0 left-0 w-[300px] h-[300px] bg-emerald-500/10 rounded-full blur-[100px] pointer-events-none"></div>

                        <Notification 
                            message={notify.message} 
                            type={notify.type} 
                            onClose={() => setNotify({ message: '', type: '' })} 
                        />
                        
                        <div className="max-w-7xl mx-auto">
                            {activeTab === 'dashboard' && <Dashboard />}
                            {activeTab === 'showcase' && <PrototypeShowcase />}
                            {activeTab === 'scanner' && <Scanner setNotify={setNotify} />}
                            {activeTab === 'ecosystem' && <DigitalEcosystem history={history} />}
                            {activeTab === 'history' && <History history={history} onDelete={deleteHistory} onClear={clearHistory} />}
                            {activeTab === 'market' && <CarbonMarket />}
                            {activeTab === 'plans' && <SubscriptionPlans />}
                            {activeTab === 'chatbot' && <Chatbot setNotify={setNotify} />}
                        </div>
                    </main>
                </div>
            );
        };

        // Initialize App with Error Boundary
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            // Remove loading screen after mount
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }, 500);
        } catch (e) {
            document.getElementById('root').innerHTML = `
                <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0F172A; color: #F8FAFC; padding: 20px; font-family: sans-serif;">
                    <h1 style="color: #10B981;">Render Error</h1>
                    <p>Failed to mount React application.</p>
                    <pre style="background: #1E293B; padding: 15px; border-radius: 8px; font-size: 12px; margin-top: 10px;">${e.message}</pre>
                </div>
            `;
        }
    </script>
    <script>
        // Register Service Worker with cache-busting to force update from old stuck versions
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js?v=' + Date.now())
                    .then(reg => {
                        console.log('[PWA] Service Worker Update Triggered', reg);
                        if (reg.installing) console.log('[PWA] SW Installing...');
                    })
                    .catch(err => console.log('[PWA] Service Worker Registration Failed', err));
            });
        }
    </script>
</body>
</html>
